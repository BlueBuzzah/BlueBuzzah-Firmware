name: Build

on:
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Display build info
        run: |
          echo "Building BlueBuzzah Firmware"
          echo "============================"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

      - name: Build firmware
        run: |
          python build/build.py \
            --clean \
            --verbose

      - name: List build artifacts
        working-directory: dist
        run: |
          echo "Build artifacts:"
          find . -type f -name "*.mpy" | sort
          echo ""
          echo "Total .mpy files: $(find . -type f -name '*.mpy' | wc -l)"
          echo "Total size: $(du -sh . | cut -f1)"

      - name: Create build archive
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          ARCHIVE_NAME="bluebuzzah-firmware-${SHORT_SHA}"

          cd dist
          zip -r "../${ARCHIVE_NAME}.zip" .
          cd ..

          echo "Created archive: ${ARCHIVE_NAME}.zip"
          ls -lh "${ARCHIVE_NAME}.zip"

          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: bluebuzzah-firmware-*
          path: artifacts
